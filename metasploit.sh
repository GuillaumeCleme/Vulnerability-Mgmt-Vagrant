#!/bin/bash
echo Metasploit setup started

# Install Dependencies
sudo apt-get update
sudo apt-get dist-upgrade -y
sudo apt-get -y install curl build-essential git tig vim john nmap libpq-dev libpcap-dev gnupg2 fortune postgresql postgresql-contrib

# Pull Metasploit Repo
cd ~
git clone https://github.com/rapid7/metasploit-framework.git

# Build from source
#gpg --keyserver hkp://keys.gnupg.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3
gpg2 --keyserver hkp://pool.sks-keyservers.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB

curl -L https://get.rvm.io | bash -s stable

source ~/.rvm/scripts/rvm
cd ~/metasploit-framework
rvm install `cat .ruby-version`
source ~/.rvm/scripts/rvm
bundle

# Setup DB
mkdir -p ~/.msf4
cp ~/metasploit-framework/config/database.yml.vagrant ~/.msf4/database.yml
sudo -u postgres psql postgres -tAc "SELECT 1 FROM pg_roles WHERE rolname='vagrant'" | grep -q 1 || sudo -u postgres createuser -s -e -w vagrant && sudo -u postgres psql -c "ALTER USER vagrant with ENCRYPTED PASSWORD 'vagrant';"

sudo -u postgres psql -lqt | awk '{ print $1 }' | grep -w msf_dev_db | wc -l | grep -q 1 || sudo -u postgres createdb --owner vagrant msf_dev_db
sudo -u postgres psql -lqt | awk '{ print $1 }' | grep -w msf_test_db | wc -l | grep -q 1 || sudo -u postgres createdb --owner vagrant msf_test_db